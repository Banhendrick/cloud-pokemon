# Etapas de compilación
steps:
  # Actualiza los submódulos de Git en su proyecto
  - name: gcr.io/cloud-builders/git
    args: ['submodule', 'update', '--init']
  # Compila la imagen Docker y la etiqueta con el valor $COMMIT_SHA
  - name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/fc-labs-pro-lab2/pokemon-nginx:app', '-f', 'Dockerfile', '.']
  # Sube la imagen de Nginx recién creada a Google Container Registry
  - name: gcr.io/cloud-builders/docker
    args: ['push', 'gcr.io/fc-labs-pro-lab2/pokemon-nginx:app']
  # Compila la imagen Docker de Helm
  - name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/fc-labs-pro-lab2/pokemon-helm:latest', '-f', 'helm/Dockerfile', '.']
  # Sube la imagen de Helm recién creada a Google Container Registry
  - name: gcr.io/cloud-builders/docker
    args: ['push', 'gcr.io/fc-labs-pro-lab2/pokemon-helm:latest']
  # Actualiza el helm release en su clúster de Kubernetes
  - name: gcr.io/cloud-builders/kubectl
    args:
      - 'apply'
      - '-f'
      - 'nginx-chart/templates/deployment.yaml'
    env:
      - 'CLOUDSDK_COMPUTE_ZONE=europe-southwest1-a'
      - 'CLOUDSDK_CONTAINER_CLUSTER=gke-pokemon'
    annotations:
      "kubectl.kubernetes.io/last-applied-configuration": "{\"apiVersion\":\"apps/v1\",\"kind\":\"Deployment\",\"metadata\":{\"annotations\":{},\"creationTimestamp\":null,\"name\":\"pokemon-nginx\",\"namespace\":\"default\"},\"spec\":{\"replicas\":{{.Values.replicaCount}},\"selector\":{\"matchLabels\":{\"app\":\"nginx\"}},\"template\":{\"metadata\":{\"creationTimestamp\":null,\"labels\":{\"app\":\"nginx\"}},\"spec\":{\"containers\":[{\"image\":\"{{.Values.image.repository}}:{{.Values.image.tag}}\",\"name\":\"nginx-container\",\"ports\":[{\"containerPort\":{{.Values.container.port}},\"name\":\"http\"}],\"resources\":{}}],\"restartPolicy\":\"Always\"}}},\"status\":{}}"
  - name: gcr.io/fc-labs-pro-lab2/helm
    entrypoint: /bin/sh
    args: ['-c', 'helm upgrade pokemon nginx-chart --namespace default --set image.tag=app']
    env:
      - 'CLOUDSDK_COMPUTE_ZONE=europe-southwest1-a'
      - 'CLOUDSDK_CONTAINER_CLUSTER=gke-pokemon'

# Imágenes a ser creadas por la etapa de compilación
images:
  - gcr.io/fc-labs-pro-lab2/pokemon-nginx:app
  - gcr.io/fc-labs-pro-lab2/helm

